<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html>

<head>
    <title>OT-Thing OpenTherm controller</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #210;
            color: #fd975a;
            font-family: sans-serif;
        }

        #mainwrapper {
            max-width: 400px;
            margin: 0px auto;
            background-color: black;
            padding: 5px;
        }

        h2 {
            background-color: #fd975a;
            color: #000;
            padding: 10px;
        }

        div.nav {
            margin-bottom: 5px;
            /*border: 1px solid #fd975a;;*/
        }

        div.nav li {
            display: inline-block;
            list-style-type: none;
            padding: 5px;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        div.nav li,
        div.nav a {
            Color: #fd975a;
            ;
            font-weight: bold;
            font-size: 0.8em;
            text-decoration: None;
        }

        div.nav li:hover {
            background-color: #444;
            cursor: pointer;
        }

        div.nav li.active {
            background-color: #fd975a;
            ;
            color: black;
        }

        div.group {
            border: 2px solid #fd975a;
            border-radius: 6px;
            padding: 5px;
        }

        div.flexline {
            display: flex;
            margin-bottom: 0.4em;
            flex-wrap: wrap;
        }

        div.statusfield {
            min-width: 50%;
            padding-bottom: 0.5em;
        }

        div.param {
            padding-right: 1em;
            padding-bottom: 0.3em;
        }

        h3 {
            font-size: 1.0em;
            border-left: 6px solid #fd975a;
            margin: 0.5em 0 0.5em 0;
            padding-left: 0.5em;
        }

        h4 {
            font-size: 0.85em;
            padding-bottom: 0.3em;
        }

        h5,
        th {
            font-size: 0.7em;
        }

        div.valunit {
            display: inline-block;
            width: 25%;
        }

        .statusvalue {
            color: #fff;
        }

        div.param span.value {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
        }

        div.infobox {
            display: none;
            padding: 10px;
            color: #999;
            font-size: 0.9em;
        }

        ul {
            list-style-position: inside;
        }

        input[type=text],
        input[type=password],
        select {
            background-color: #111;
            margin: 5px 0;
            border: 1px solid #fd975a;
            color: #fff;
            padding: 3px;
        }

        input[type=range] {
            -webkit-appearance: none;
            background: #fd975a;
            height: 5px;
            margin: auto 0;
            width: 75%;
            cursor: pointer;
        }

        input[type=radio] {
            margin: 5px 0;
            cursor: pointer;
        }

        div.curve {
            text-align: center;
            background-color: #000;
            margin-top: 0.5em;
        }

        div.toolbar {
            text-align: center;
            padding: 0.3em 0;
        }

        button,
        input[type=submit] {
            background-color: #fd975a;
            color: black;
            padding: 0 1em;
            border-radius: 8px;
            border-style: none;
            box-sizing: border-box;
            font-weight: 500;
            height: 30px;
            outline: none;
            touch-action: manipulation;
            cursor: pointer;
            display: inline-block;
        }

        button:focus {
            background-color: #fd975a;
        }

        button:hover {
            background-color: #6d99a4;
        }

        button:active {
            background-color: #4d7984;
        }

        button.pressed {
            border: 1px solid #fd975a;
            background-color: black;
            color: #fd975a;
        }

        table {
            width: 100%;
            text-align: left;
        }

        table tbody {
            color: #fff;
            font-size: 0.9em;
        }

        table th.ot,
        table th.ft {
            width: 15%;
        }

        table th.rem {
            width: 8%;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 28px;
            margin: 5px 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 5px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: #8d5535;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 3px;
        }

        input:checked+.slider {
            background-color: #fd975a;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #8d5535;
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        div.footer {
            text-align: center;
            color: #fd975a;
            margin-top: 0.5em;
            padding: 5px;
        }

        div.footer a,
        div.footer a:visited {
            font-size: 0.8em;
            color: #fd975a;
            text-decoration: none;
        }

        #scanResults {
            display: none;
        }

        #scanHint {
            padding: 5px;
            display: none;
        }

        #stickydiv {
            position: sticky;
            top: 0;
            font-weight: bold;
            text-align: center;
        }

        #nocon {
            display: none;
            padding: 0.6em;
            background-color: #c00;
        }

        #console {
            background-color: black;
            height: 40em;
            color: white;
            resize: vertical;
            overflow: auto;
            padding: 0 0.5em;
        }

        #console div {
            font-family: "Lucida Console", "Courier New", monospace;
            font-size: 12px;
        }

        #logstatus {
            height: 0.5em;
        }

        #logstatus.connected {
            background-color: green;
        }

        #logstatus.disconnected {
            background-color: red;
        }

        #progressDiv {
            display: none;
        }

        #updprogress {
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="stickydiv">
        <div id="nocon">No connection to device...</div>
    </div>

    <div id="mainwrapper">
        <h2>OT Thing</h2>

        <div class="nav">
            <ul>
                <li tab="status" class="active">Status</li>
                <li tab="setup">Setup</li>
                <li tab="heatingcurve1">Heating circuit 1</li>
                <li tab="heatingcurve2">Heating circuit 2</li>
                <li tab="log">Log</li>
            </ul>
        </div>

        <div class="tab" id="status">
            <h3>System</h3>
            <div class="group">
                <div class="flexline">
                    <div class="statusfield">
                        <h5>Runtime</h5>
                        <span class="statusvalue" id="runtime"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Firmware</h5>
                        <span class="statusvalue" field="fw_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>MAC</h5>
                        <span class="statusvalue" field="wifi.mac"></span>
                    </div>
                    <div class="statusfield">
                        <h5>IP</h5>
                        <span class="statusvalue" field="wifi.ipsta"></span>
                    </div>
                    <div class="statusfield">
                        <h5>SSID</h5>
                        <span class="statusvalue" field="wifi.sta_ssid"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Hostname</h5>
                        <span class="statusvalue" field="wifi.hostname"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Status</h5>
                        <span class="statusvalue" field="wifi.status"></span>
                    </div>
                    <div class="statusfield">
                        <h5>RSSI</h5>
                        <span class="statusvalue" field="wifi.rssi" unit="dBm"></span>
                    </div>
                    <div class="statusfield">
                        <h5>MQTT connected</h5>
                        <span class="statusvalue" field="mqtt.connected"></span>
                    </div>
                </div>
            </div>
            <div id="owdiv">
                <h3>OpenWeather</h3>
                <div class="group">
                    <h5>Status</h5>
                    <span></span>
                    <h5>Outside temperature</h5>
                    <span class="statusvalue" field="outsideTemp"></span>
                    <span class="statusunit">&deg;C</span>
                </div>
            </div>
            
            <h3>Boiler</h3>
            <div class="group">
                <div class="flexline">
                    <div class="statusfield">
                        <h5>Flame</h5>
                        <span class="statusvalue" field="boiler.status.flame"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Modulation</h5>
                        <span class="statusvalue" field="boiler.rel_mod" unit="%"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Diagnosis</h5>
                        <span class="statusvalue" field="boiler.status.diagnostic"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Heater circuit 1 active</h5>
                        <span class="statusvalue" field="boiler.status.ch_mode"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Flow temperature</h5>
                        <span class="statusvalue" field="boiler.flow_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Heater circuit 2 active</h5>
                        <span class="statusvalue" field="boiler.status.ch2_mode"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Flow temperature 2</h5>
                        <span class="statusvalue" field="boiler.flow_t2" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW active</h5>
                        <span class="statusvalue" field="boiler.status.dhw_mode"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW temperature</h5>
                        <span class="statusvalue" field="boiler.dhw_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW flow rate</h5>
                        <span class="statusvalue" field="boiler.dhw_flow_rate" unit="l/min"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW temperature 2</h5>
                        <span class="statusvalue" field="boiler.dhw_t2" unit="&deg;C"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>DHW min. temperature</h5>
                        <span class="statusvalue" field="boiler.dhwMin" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW max. temperature</h5>
                        <span class="statusvalue" field="boiler.dhwMax" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Min. flow temperature</h5>
                        <span class="statusvalue" field="boiler.chMin" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Max. flow temperature</h5>
                        <span class="statusvalue" field="boiler.chMax" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Exhaust temperature</h5>
                        <span class="statusvalue" field="boiler.exhaust_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Outside temperature</h5>
                        <span class="statusvalue" field="boiler.outside_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Return temperature</h5>
                        <span class="statusvalue" field="boiler.return_t" unit="&deg;C"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Room override temp.</h5>
                        <span class="statusvalue" field="boiler.tr_override" unit="&deg;C"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Operating hours burner</h5>
                        <span class="statusvalue" field="boiler.burner_op_hours" unit="h"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Operating hours burner DHW</h5>
                        <span class="statusvalue" field="boiler.dhw_burner_op_hours" unit="h"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Burner starts</h5>
                        <span class="statusvalue" field="boiler.burner_starts"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Unsuccessful burner starts</h5>
                        <span class="statusvalue" field="boiler.unsuccessful_burner_starts"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>CH pump start</h5>
                        <span class="statusvalue" field="boiler.ch_pump_starts"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Number flame signal low</h5>
                        <span class="statusvalue" field="boiler.num_flame_signal_low"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Pressure</h5>
                        <span class="statusvalue" field="boiler.ch_pressure" unit="bar"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Product version</h5>
                        <span class="statusvalue" field="boiler.slave_prod_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>OT version</h5>
                        <span class="statusvalue" field="boiler.slave_ot_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Member ID</h5>
                        <span class="statusvalue" field="boiler.memberId"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Max. capacity</h5>
                        <span class="statusvalue" field="boiler.max_capacity" unit="kW"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Min. modulation level</h5>
                        <span class="statusvalue" field="boiler.min_modulation" unit="%"></span>
                    </div>
                    <div class="statusfield">
                        <h5>OEM fault code</h5>
                        <span class="statusvalue" field="boiler.oem_fault_code"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Frames sent</h5>
                        <span class="statusvalue" field="boiler.txCount"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Frames received</h5>
                        <span class="statusvalue" field="boiler.rxCount"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Frames timeouts</h5>
                        <span class="statusvalue" field="boiler.timeouts"></span>
                    </div>
                </div>
            </div>

            <h3>Thermostat</h3>
            <div class="group">
                <div class="flexline">
                    <div class="statusfield">
                        <h5>Heater circuit 1 enabled</h5>
                        <span class="statusvalue" field="thermostat.status.ch_enable"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Heater circuit 2 enabled</h5>
                        <span class="statusvalue" field="thermostat.status.ch2_enable"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW enabled</h5>
                        <span class="statusvalue" field="thermostat.status.dhw_enable"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Outside temp. compensation</h5>
                        <span class="statusvalue" field="thermostat.status.otc_enable"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Flow set temperature</h5>
                        <span class="statusvalue" field="thermostat.ch_set_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Flow set temperature 2</h5>
                        <span class="statusvalue" field="thermostat.ch_set_t2" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW set temperature</h5>
                        <span class="statusvalue" field="thermostat.dhw_set_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room temperature</h5>
                        <span class="statusvalue" field="thermostat.room_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room set temperature</h5>
                        <span class="statusvalue" field="thermostat.room_set_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room temperature 2</h5>
                        <span class="statusvalue" field="thermostat.room_t2" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room set temperature 2</h5>
                        <span class="statusvalue" field="thermostat.room_set_t2" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Max. rel. modulation</h5>
                        <span class="statusvalue" field="thermostat.max_rel_mod" unit="%"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Product version</h5>
                        <span class="statusvalue" field="thermostat.master_prod_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>OT version</h5>
                        <span class="statusvalue" field="thermostat.master_ot_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Member ID</h5>
                        <span class="statusvalue" field="thermostat.memberId"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Smart power</h5>
                        <span class="statusvalue" field="thermostat.smartPower"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Frames sent</h5>
                        <span class="statusvalue" field="thermostat.txCount"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Frames received</h5>
                        <span class="statusvalue" field="thermostat.rxCount"></span>
                    </div>
                </div>
            </div>

            <h3>1-wire</h3>
            <div class="group">
                <div class="flexline" id="oneWireSensors">
                </div>
            </div>
        </div>

        <div class="tab" id="heatingcurve1">
            <h3>Dimensioning</h3>
            <div class="group">
                <div id="flowmax1" class="param">
                    <h5>Max. flow temperature</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="30" max="90" step="1">
                    </div>
                    <div class="infobox">
                        Gängige Systemtemperaturen Vorlauf/R&uuml;cklauf:
                        <ul>
                            <li>Alte Norm: 90 &deg;C / 70 &deg;C</li>
                            <li>Neue Norm: 75 &deg;C / 65 &deg;C</li>
                            <li>Niedertemperatur: 70 &deg;C / 50 &deg;C</li>
                            <li>Brennwert: 60 &deg;C / 45 &deg;C</li>
                            <li>Brennwert: 45 &deg;C / 35 &deg;C</li>
                        </ul>
                        <p>Quelle: <a href="www.bosy-online.de">www.bosy-online.de</a></p>
                    </div>
                </div>

                <div id="exponent1" class="param">
                    <h5>Heating surface exponent</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                        </div>
                        <input type="range" min="1.0" max="1.5" step="0.05">
                    </div>
                    <div class="infobox">
                        Je nach Anteil von Leitung, Konvektion und Strahlung ist das Verhältnis von Vorlauftemperatur
                        und
                        Wärmeabgabe überliniear:
                        <ul>
                            <li>Fußbodenheizung: 1,0 - 1,05</li>
                            <li>Flachheizkörper: 1,26 - 1,33</li>
                            <li>Handtuchradiatoren: 1,20 - 1,30</li>
                            <li>Heizkörper nach DIN 4703: 1,3</li>
                            <li>Konvektoren: 1,30 - 1,50</li>
                        </ul>
                        <p>Quelle: <a href="www.bosy-online.de">www.bosy-online.de</a></p>
                    </div>
                </div>
            </div>

            <h3>Setup</h3>
            <div class="group">
                <div id="chset1" class="param">
                    <h5>flow set temperature (default)</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="25" max="90" step="1" />
                    </div>
                </div>

                <div id="roomset1" class="param">
                    <h5>Room set temperature (default)</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="17" max="23" step="0.1">
                    </div>
                </div>

                <div class="param">
                    <h5>Room setpoint source</h5>
                    <select id="selectRoomSetpointSource1" field="boiler.heating.0.roomsetpoint.source">
                        <option value="0">MQTT</option>
                        <option value="1">OT roomunit</option>
                    </select>
                    <div class="selopt">
                        <h5>Topic</h5>
                        <div class="statusfield statusvalue">
                            <span class="mqttbasetopic"></span><span>/roomSetpoint1/set</span>
                        </div>
                    </div>
                    <div class="selopt">
                    </div>
                </div>

                <div id="roomtempcomp1" class="param">
                    <h5>Room temperature compensation</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C/&deg;C</span>
                        </div>
                        <input type="range" min="0" max="5" step="0.1">
                    </div>
                </div>

                <div class="param">
                    <h5>Current room temperature source</h5>
                    <select id="selectRoomTempSource1" field="boiler.heating.0.roomtemp.source">
                        <option value="0">MQTT</option>
                        <option value="1">OT roomunit</option>
                        <option value="2">Bluetooth</option>
                        <option value="3">1wire</option>
                    </select>
                    <div class="selopt">
                        <h5>Topic</h5>
                        <div class="statusfield statusvalue">
                            <span class="mqttbasetopic"></span><span>/roomTemp1/set</span>
                        </div>
                    </div>
                    <div class="selopt">
                    </div>
                    <div class="selopt">
                        <h5>address</h5>
                        <select id="bleRoomTempAdr1" class="bleAdr">
                        </select>
                    </div>
                    <div class="selopt">
                        <h5>address</h5>
                        <select id="oneWireRoomTempAdr1" class="oneWireAdr">
                        </select>
                    </div>
                </div>
            </div>

            <h3>Scheduler</h3>
            <div class="group" style="display: none">
                <table>
                    <thead>
                        <tr>
                            <th class="days">days</th>
                            <th class="time">time</th>
                            <th class="ft">room set temperature</th>
                            <th class="rem"></th>
                        </tr>
                    </thead>
                    <tbody id="schedulerbody1">
                    </tbody>
                </table>
                <button id="addscheduler1" channel="1">+</button>
            </div>

            <h3>Heating curve</h3>
            <div class="group">
                <div id="gradient1" class="param">
                    <h5>Gradient</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                        </div>
                        <input type="range" min="0.2" max="3" step="0.05">
                    </div>
                    <div class="infobox">
                        <p>
                            Quelle: <a href="http://www.bosy-online.de/Heizkurve.htm">www.bosy-online.de</a>
                        </p>
                    </div>
                </div>

                <div id="offset1" class="param">
                    <h5>Offset</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="-10" max="10" step="0.5">
                    </div>
                </div>

                <div class="flexline">
                    <div class="statusfield">
                        <h5>Outside temperature</h5>
                        <span class="statusvalue" field="outsideTemp" unit="°C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room set point</h5>
                        <span class="statusvalue" field="heatercircuit.0.roomsetpoint" unit="°C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room temperature</h5>
                        <span class="statusvalue" field="heatercircuit.0.roomtemp" unit="&deg;C"></span>
                    </div>
                </div>

                <div class="curve">
                    <canvas id="canvas1" height="375px" width="375px">
                    </canvas>
                </div>
            </div>

            <h3>Marker</h3>
            <div class="group">
                <table>
                    <thead>
                        <tr>
                            <th class="comment">comment</th>
                            <th class="ot">outside</th>
                            <th class="ft">flow</th>
                            <th class="rem"></th>
                        </tr>
                    </thead>
                    <tbody id="markerbody1">
                    </tbody>
                </table>
                <input type="text" id="comment1" />
                <button id="addmarker1">+</button>
            </div>
        </div>

        <div class="tab" id="heatingcurve2">
            <h3>Dimensioning</h3>
            <div class="group">
                <div id="flowmax2" class="param">
                    <h5>Max. flow temperature</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="30" max="90" step="1">
                    </div>
                    <div class="infobox">
                        Gängige Systemtemperaturen Vorlauf/R&uuml;cklauf:
                        <ul>
                            <li>Alte Norm: 90 &deg;C / 70 &deg;C</li>
                            <li>Neue Norm: 75 &deg;C / 65 &deg;C</li>
                            <li>Niedertemperatur: 70 &deg;C / 50 &deg;C</li>
                            <li>Brennwert: 60 &deg;C / 45 &deg;C</li>
                            <li>Brennwert: 45 &deg;C / 35 &deg;C</li>
                        </ul>
                        <p>Quelle: <a href="www.bosy-online.de">www.bosy-online.de</a></p>
                    </div>
                </div>

                <div id="exponent2" class="param">
                    <h5>Heating surface exponent</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                        </div>
                        <input type="range" min="1.0" max="1.5" step="0.05">
                    </div>
                    <div class="infobox">
                        Je nach Anteil von Leitung, Konvektion und Strahlung ist das Verhältnis von Vorlauftemperatur
                        und
                        Wärmeabgabe überliniear:
                        <ul>
                            <li>Fußbodenheizung: 1,0 - 1,05</li>
                            <li>Flachheizkörper: 1,26 - 1,33</li>
                            <li>Handtuchradiatoren: 1,20 - 1,30</li>
                            <li>Heizkörper nach DIN 4703: 1,3</li>
                            <li>Konvektoren: 1,30 - 1,50</li>
                        </ul>
                        <p>Quelle: <a href="www.bosy-online.de">www.bosy-online.de</a></p>
                    </div>
                </div>
            </div>

            <h3>Setup</h3>
            <div class="group">
                <div id="chset2" class="param">
                    <h5>flow set temperature (default)</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="25" max="90" step="1" />
                    </div>
                </div>

                <div id="roomset2" class="param">
                    <h5>Room set temperature (default)</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="17" max="23" step="0.1">
                    </div>
                    <div class="infobox">
                    </div>
                </div>
                <div class="param">
                    <h5>Room setpoint source</h5>
                    <select id="selectRoomSetpointSource2" field="boiler.heating.1.roomsetpoint.source">
                        <option value="0">MQTT</option>
                        <option value="1">OT roomunit</option>
                    </select>
                    <div class="selopt">
                        <h5>Topic</h5>
                        <div class="statusfield statusvalue">
                            <span class="mqttbasetopic"></span><span>/roomSetpoint2/set</span>
                        </div>
                    </div>
                    <div class="selopt">
                    </div>
                </div>
                <div id="roomtempcomp2" class="param">
                    <h5>Room temperature compensation</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C/&deg;C</span>
                        </div>
                        <input type="range" min="0" max="5" step="0.1">
                    </div>
                </div>
                <div class="param">
                    <h5>Current room temperature source</h5>
                    <select id="selectRoomTempSource2" field="boiler.heating.1.roomtemp.source">
                        <option value="0">MQTT</option>
                        <option value="1">OT roomunit</option>
                        <option value="2">Bluetooth</option>
                        <option value="3">1wire</option>
                    </select>
                    <div class="selopt">
                        <h5>Topic</h5>
                        <div class="statusfield statusvalue">
                            <span class="mqttbasetopic"></span><span>/roomTemp2/set</span>
                        </div>
                    </div>
                    <div class="selopt">
                    </div>
                    <div class="selopt">
                        <h5>address</h5>
                        <select id="bleRoomTempAdr2" class="bleAdr">
                        </select>
                    </div>
                    <div class="selopt">
                        <h5>address</h5>
                        <select id="oneWireRoomTempAdr2" class="oneWireAdr">
                        </select>
                    </div>
                </div>
            </div>

            <h3>Heating curve</h3>
            <div class="group">
                <div id="gradient2" class="param">
                    <h5>Gradient</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                        </div>
                        <input type="range" min="0.2" max="3" step="0.05">
                    </div>
                    <div class="infobox">
                        <p>
                            Quelle: <a href="http://www.bosy-online.de/Heizkurve.htm">www.bosy-online.de</a>
                        </p>
                    </div>
                </div>

                <div id="offset2" class="param">
                    <h5>Offset</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="-10" max="10" step="0.5">
                    </div>
                </div>

                <div class="flexline">
                    <div class="statusfield">
                        <h5>Outside temperature</h5>
                        <span class="statusvalue" field="outsideTemp" unit="°C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room set point</h5>
                        <span class="statusvalue" field="heatercircuit.1.roomsetpoint" unit="°C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room temperature</h5>
                        <span class="statusvalue" field="heatercircuit.1.roomtemp" unit="°C"></span>
                    </div>
                </div>

                <div class="curve">
                    <canvas id="canvas2" height="375px" width="375px">
                    </canvas>
                </div>
            </div>

            <h3>Marker</h3>
            <div class="group">
                <table>
                    <thead>
                        <tr>
                            <th class="comment">comment</th>
                            <th class="ot">outside</th>
                            <th class="ft">flow</th>
                            <th class="rem"></th>
                        </tr>
                    </thead>
                    <tbody id="markerbody2">
                    </tbody>
                </table>
                <input type="text" id="comment2" />
                <button id="addmarker2">+</button>
            </div>
        </div>

        <div class="tab" id="setup">
            <h3>WiFi</h3>
            <div class="group">
                <button id="scan">scan</button><span id="scanHint">Scan running...</span>
                <div id="scanResults">
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>SSID</th>
                                <th>channel</th>
                                <th>RSSI</th>
                            </tr>
                        </thead>
                        <tbody id="scanbody">
                        </tbody>
                    </table>
                    <h5>SSID</h5>
                    <input id="wifissid" type="text"/>
                    <h5>Passwort</h5>
                    <input id="wifipass" type="password"/>
                    <div><button id="btnsavewifi">connect</button></div>
                </div>
            </div>

            <h3>OpenTherm</h3>
            <div class="group">
                <h4>Mode</h4>
                <div class="flexline">
                    <div class="param">
                        <input type="radio" name="otMode" value="0">
                        <label>Bypass</label>
                    </div>
                    <div class="param">
                        <input type="radio" name="otMode" value="1">
                        <label>Master</label>
                    </div>
                    <div class="param">
                        <input type="radio" name="otMode" value="2">
                        <label>Repeater</label>
                    </div>
                    <div class="param" style="display: block">
                        <input type="radio" name="otMode" value="4">
                        <label>Test</label>
                    </div>
                </div>
                <div class="flexline">
                    <div class="param">
                        <h5>Circuit 1</h5>
                        <label class="switch">
                            <input id="chOn1" type="checkbox" />
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="param">
                        <h5>Circuit 2</h5>
                        <label class="switch">
                            <input id="chOn2" type="checkbox" />
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="param">
                        <h5>Cooling</h5>
                        <label class="switch">
                            <input id="coolOn" type="checkbox" />
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="param">
                        <h5>DHW</h5>
                        <label class="switch">
                            <input id="dhwOn" type="checkbox" />
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div id="dhwtemp" class="param">
                    <h5>DHW set temperature</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="30" max="70" step="1" />
                    </div>
                </div>

                <div class="otmode-master">
                    <div class="param">
                        <h5>Member ID</h5>
                        <input id="masterMemberId" type="text" />
                    </div>
                </div>

                <div class="otmode-repeater">
                    <h4>override values</h4>
                    <div class="flexline">
                        <div class="param">
                            <h5>flow temp. 1</h5>
                            <label class="switch">
                                <input id="overrideFlow1" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param">
                            <h5>flow temp. 2</h5>
                            <label class="switch">
                                <input id="overrideFlow2" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param">
                            <h5>DHW set temp</h5>
                            <label class="switch">
                                <input id="overrideDhw" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <h3>MQTT</h3>
            <div class="group">
                <h5>Host</h5>
                <input id="mqttHost" type="text" />
                <div class="flexline">
                    <div class="param">
                        <h5>Port</h5>
                        <input id="mqttPort" type="text" />
                    </div>
                    <div class="param">
                        <h5>TLS</h5>
                        <div>
                            <label class="switch">
                                <input id="mqttTls" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flexline">
                    <div class="param">
                        <h5>Username</h5>
                        <input id="mqttUser" type="text" />
                    </div>
                    <div class="param">
                        <h5>Password</h5>
                        <input id="mqttPass" type="password" />
                    </div>
                </div>                
            </div>

            <h3>Outside temperature</h3>
            <div class="group">
                <h5>Source</h5>
                <select id="selectOutsideTempSource" field="outsideTemp.source">
                    <option value="0">MQTT</option>
                    <option value="1">OT boiler</option>
                    <option value="2">Bluetooth</option>
                    <option value="4">OpenWeather</option>
                </select>
                <div class="selopt">
                    <h5>Topic</h5>
                    <div class="statusfield statusvalue">
                        <span class="mqttbasetopic"></span><span>/outsideTemp/set</span>
                    </div>
                </div>
                <div class="selopt">
                </div>
                <div class="selopt">
                    <h5>Address</h5>
                    <input id="inpbluetoothaddress" type="text" />
                </div>
                <div class="selopt">
                    <h5>API-Key</h5>
                    <input id="inpapikey" type="password" />
                    <h5>Breitengrad</h5>
                    <input id="inplat" type="text" />
                    <h5>L&auml;ngengrad</h5>
                    <input id="inplon" type="text" />
                    <h5>Interval / s</h5>
                    <input id="inpinterval" type="text" />
                </div>
            </div>

            <h3>Firmware</h3>
            <div class="group">
                <form id="form_upload" method='POST' enctype='multipart/form-data'>
                    <input id="inp_file" type='file' accept='.bin,.bin.gz' name='firmware'>
                    <input id="btn_upload" type='submit' value='upload'>
                    <div id="progressDiv" class="progress">
                        <div id="progressText"></div>
                        <progress id="updprogress" max="100" value="0"></progress>
                    </div>
                </form>
            </div>
        </div>

        <div class="tab" id="log">
            <div id="console">
            </div>
            <div id="logstatus"></div>
            <div class="toolbar">
                <button id="btnclearlog">clear log</button>
                <button id="btnautoscroll">autoscroll</button>
            </div>
        </div>

        <div class="toolbar">
            <button id="save">save</button>
            <button id="reboot">reboot</button>
        </div>

        <div class="footer"><a href="http://www.seegel-systeme.de" target="_blank">www.seegel-systeme.de</a></div>
    </div>
    <script>
        var config = {
            otMode: 4,
            boiler: {
                dhwOn: true,
                dhwTemperature: 50,
                heating: [
                    {
                        flow: 45,
                        roomSet: 21,
                        roomtempcomp: 0,
                        chOn: true,
                        flowMax: 60,
                        exponent: 1.3,
                        gradient: 1.4,
                        offset: 0,
                        marker: [],
                        roomsetpoint: {
                            "source": 0
                        },
                        roomtemp: {
                            "source": 1
                        },
                        overrideFlow: false
                    },
                    {
                        flow: 30,
                        roomSet: 21,
                        roomtempcomp: 0,
                        chOn: true,
                        flowMax: 60,
                        exponent: 1.3,
                        gradient: 1.4,
                        offset: 0,
                        marker: [],
                        roomsetpoint: {
                            "source": 0
                        },
                        roomtemp: {
                            "source": 1
                        },
                        overrideFlow: false
                    }
                ],
                overrideDhw: false
            },
            outsideTemp: {
                source: 0
            },
            mqtt: {
            },
            masterMemberId: 8
        },
        statuscache = {};

        function _(query) {
            return document.querySelector(query);
        }

        function __(query) {
            return document.querySelectorAll(query);
        }

        function _$(elename, props = {}, ...children) {
            const result = document.createElement(elename);
            Object.assign(result, props);
            result.append(...children);
            return result;
        }

        window.onload = () => {
            items = __("div.nav li");
            items.forEach(function (item) {
                item.onclick = (ev) => {
                    __("div.nav li").forEach((item) => {
                        item.classList.remove("active");
                    });
                    __(".tab").forEach(function (item) {
                        item.style.display = "none";
                    });
                    document.getElementById(ev.target.getAttribute("tab")).style.display = "";
                    ev.target.classList.add("active");
                };
            });
            _("div.nav li.active").click();

            let xhrSaveConfig = new XMLHttpRequest();
            //eventhandler for save button
            _("#save").onclick = () => {
                config.otMode = (_('input[name="otMode"]:checked') !== undefined) ? parseInt(_('input[name="otMode"]:checked').value) : null,
                config.outsideTemp = {
                    source: parseInt(_('#selectOutsideTempSource').value),
                    apikey: _("#inpapikey").value,
                    lat: parseFloat(_("#inplat").value),
                    lon: parseFloat(_("#inplon").value),
                    interval: parseInt(_("#inpinterval").value),
                };

                let heating0 = config.boiler.heating[0];
                heating0.chOn = _("#chOn1").checked;
                heating0.overrideFlow = _("#overrideFlow1").checked;
                delete heating0.roomtemp["adr"];
                if (heating0.roomtemp.source == 3) {
                    heating0.roomtemp["adr"] = _("#oneWireRoomTempAdr1").value;
                }

                let heating1 = config.boiler.heating[1];
                heating1.chOn = _("#chOn2").checked;
                heating1.overrideFlow = _("#overrideFlow2").checked;
                delete heating1.roomtemp["adr"];
                if (heating1.roomtemp.source == 3) {
                    heating1.roomtemp["adr"] = _("#oneWireRoomTempAdr2").value;
                }
                    
                config.boiler.dhwOn = _("#dhwOn").checked;
                config.boiler.coolOn = _("#coolOn").checked;
                config.boiler.overrideDhw = _("#overrideDhw").checked;

                config.mqtt = {
                    host: _("#mqttHost").value,
                    port: parseInt(_("#mqttPort").value),
                    user: _("#mqttUser").value,
                    pass: _("#mqttPass").value,
                    tls: _("#mqttTls").checked
                };

                config.masterMemberId = parseInt(_("#masterMemberId").value);

                xhrSaveConfig.open("POST", "config");
                xhrSaveConfig.setRequestHeader("Content-Type", "application/json");
                xhrSaveConfig.send(JSON.stringify(config));
                xhrSaveConfig.onload = (ev) => {
                    alert("configuration saved successfully");
                };
            };

            //eventhandler for save button
            let xhrWiFiSet = new XMLHttpRequest();
            xhrWiFiSet.onload = (ev) => {
            };
            _("#btnsavewifi").onclick = (ev) => {
                xhrWiFiSet.open('POST', 'setwifi');
                xhrWiFiSet.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                let params = "ssid=" + encodeURIComponent(_("#wifissid").value) + 
                        "&pass=" + encodeURIComponent(_("#wifipass").value); 
                xhrWiFiSet.send(params);
            };

            function addMarker(hk) {
                if (!('outsideTemp' in statuscache)) {
                    alert("No outside temperature available!");
                    return;
                }
                let heatCfg = config.boiler.heating[hk - 1];
                let ft = getFlowTemperature(
                    statuscache.outsideTemp, 
                    heatCfg.roomSet, 
                    heatCfg.flowMax, 
                    heatCfg.exponent, 
                    heatCfg.gradient, 
                    heatCfg.offset
                );
                let comment = _("#comment" + hk).value;
                heatCfg.marker.push({
                    comment: comment,
                    ot: statuscache.outsideTemp,
                    ft: Math.round(ft * 10) / 10
                });
                _("#comment" + hk).value = "";
                drawMarkerTable(hk);
                drawCurve(hk);
            }
            
            //eventhandler for add marker button
            _("#addmarker1").onclick = () => {
                addMarker(1);
            };
            //eventhandler for add marker button
            _("#addmarker2").onclick = () => {
                addMarker(2);
            };

            function addScheduler(channel) {
                hcfg = config.boiler.heating[channel -1];
                if (!("scheduler" in hcfg))
                    hcfg["scheduler"] = [];
                hcfg.scheduler.push({
                    "days": [],
                    "time": "8:00",
                    "temp": 21
                });

                drawSchedulerTable(channel);
            }

            _("#addscheduler1").onclick = (ev) => {
                addScheduler(1);
            };

            let xhrWiFiScan = new XMLHttpRequest();
            xhrWiFiScan.onload = (e) => {
                let scanObj = JSON.parse(e.target.responseText);
                if (scanObj.status < 0) {
                    setTimeout(scanWiFi, 1000);
                    return;
                }

                _("#scanResults").style.display = 'block';
                _("#scanHint").style.display = 'none';

                scanObj.results.forEach(element => {
                    _("#scanbody").append(
                        _$("tr", {},
                            _$("td", {},
                                _$("input", {
                                    type: "radio", 
                                    name: "ssid", 
                                    value: element.ssid, 
                                    onclick: (ev) => {_("#wifissid").value = ev.target.value;}
                                })
                            ),
                            _$("td", {textContent: element.ssid}),
                            _$("td", {textContent: element.channel}),
                            _$("td", {textContent: element.rssi})
                        )
                    );
                });
            };
            // eventhandler for scan button
            _("#scan").onclick = (ev) => {
                _("#scanResults").style.display = 'none';
                _("#scanHint").style.display = 'inline';
                _("#scanbody").innerHTML = "";
                scanWiFi();
            };
            function scanWiFi() {
                xhrWiFiScan.open("GET", "scan");    
                xhrWiFiScan.send();
            }

            __("select").forEach((ele, index) => {
                ele.onchange = (ev) => {
                    var f = ele.getAttribute('field');
                    if (f == null)
                        return;
                    f = f.split('.');
                    val = config;
                    var i;
                    for (i=0; i<f.length-1; i++) {
                        if (!(f[i] in val))
                            val[f[i]] = {}
                        val = val[f[i]];
                    }
                    val[f[i]] = parseInt(ev.target.value);
                    ev.target.parentElement.querySelectorAll("div.selopt").forEach((ele, index) => {
                        ele.style.display = (index == ev.target.selectedIndex) ? "block": "none";
                    });
                }
            });

            _("#selectOutsideTempSource").addEventListener("change", (ev) => {
                _("#owdiv").style.display = (ev.target.value == 4) ? "block" : "none";
            });

            function drawMarkerTable(hk) {
                if (hk === undefined) {
                    drawMarkerTable(1);
                    drawMarkerTable(2);
                    return;
                }
                _("#markerbody" + hk).innerHTML = "";
                
                var i = 0;
                config.boiler.heating[hk - 1].marker.forEach(function (item) {
                    _(`#markerbody${hk}`).append(
                        _$("tr", {}, 
                            _$("td", {textContent: item.comment}),
                            _$("td", {textContent: item.ot + " °C"}),
                            _$("td", {textContent: item.ft + " °C"}),
                            _$("td", {},
                                _$("button", {
                                    className: "rmmarker", 
                                    textContent: "-",
                                    onclick: (ev) => {
                                        config.boiler.heating[hk - 1].marker.splice(ev.target.getAttribute("index"), 1);
                                        drawMarkerTable(hk);
                                        drawCurve(hk);
                                    }
                                })
                            )
                        )
                    );

                    _(`#markerbody${hk} tr:last-child button`).setAttribute("index", i++);
                });
            }

            function drawSchedulerTable(channel) {
                if (channel === undefined) {
                    drawSchedulerTable(1);
                    drawSchedulerTable(2);
                    return;
                }
                _("#schedulerbody" + channel).innerHTML = "";
                
                var i = 0;
                config.boiler.heating[channel - 1].scheduler.forEach(function (item) {
                    _(`#schedulerbody${channel}`).append(
                        _$("tr", {}, 
                            _$("td", {}),
                            _$("td", {textContent: item.time}),
                            _$("td", {textContent: item.temp + " °C"}),
                            _$("td", {},
                                _$("button", {
                                    className: "rmscheduler", 
                                    textContent: "-",
                                    onclick: (ev) => {
                                        config.boiler.heating[channel - 1].scheduler.splice(ev.target.getAttribute("index"), 1);
                                        drawSchedulerTable(channel);
                                    }
                                })
                            )
                        )
                    );

                    _(`#schedulerbody${channel} tr:last-child button`).setAttribute("index", i++);
                });
            }

            function setParam(name, val) {
                var slider = _('#' + name + " input[type=range]");
                slider.value = val;
                _("#" + name + " span.value").innerHTML = val;
            }

            function initRangeParam(name, configPath) {
                var cfgVal = config;
                let p = configPath.split('.');
                for (var i=0, len = p.length; i<len; i++) {
                    cfgVal = cfgVal[p[i]];
                };

                setParam(name, cfgVal);

                var slider = _('#' + name + " input[type=range]");
                var path = configPath;
                slider.addEventListener("input", (ev) => {
                    setParam(name, ev.target.value);

                    var cfgVal = config;
                    var p = path.split('.')
                    for (var i=0, len = p.length; i<len; i++) {
                        if (i<len-1) {
                            cfgVal = cfgVal[p[i]];
                        }
                        else
                            cfgVal[p[i]] = parseFloat(ev.target.value);
                    };
                    drawCurve();
                });
            }

            let xhrConfig = new XMLHttpRequest();
            xhrConfig.onload = (ev) => {
                try {
                    config = JSON.parse(ev.target.responseText);
                }
                catch (err) {
                }
                configToUi();
            };
            xhrConfig.onerror = (ev) => {
                configToUi();
            };
            xhrConfig.open("GET", "config");
            xhrConfig.send();
            function configToUi() {
                let otradio = _('input[name="otMode"][value="' + config.otMode + '"]');
                if (otradio !== undefined) {
                    otradio.checked = true;
                    otradio.dispatchEvent(new Event('click'));
                }

                _("#masterMemberId").value = config.masterMemberId || 8;

                _("#selectOutsideTempSource").value = config.outsideTemp.source;
                _("#selectOutsideTempSource").dispatchEvent(new Event('change'));
                _("#inpapikey").value = config.outsideTemp.apikey;
                _("#inplat").value = config.outsideTemp.lat || null;
                _("#inplon").value = config.outsideTemp.lon || null;
                _("#inpinterval").value = config.outsideTemp.interval || null;

                _("#mqttHost").value = config.mqtt.host || null;
                _("#mqttPort").value = config.mqtt.port || 1883;
                _("#mqttTls").checked = config.mqtt.tls || false;
                _("#mqttUser").value = config.mqtt.user || null;
                _("#mqttPass").value = config.mqtt.pass || null;

                _("#dhwOn").checked = config.boiler.dhwOn;
                _("#coolOn").checked = config.boiler.coolOn;
                _("#overrideDhw").checked = config.boiler.overrideDhw;
                initRangeParam("dhwtemp", "boiler.dhwTemperature");

                _("#chOn1").checked = config.boiler.heating[0].chOn;
                _("#overrideFlow1").checked = config.boiler.heating[0].overrideFlow || false;
                initRangeParam("chset1", "boiler.heating.0.flow");
                initRangeParam("roomset1", "boiler.heating.0.roomSet");
                initRangeParam("flowmax1", "boiler.heating.0.flowMax");
                initRangeParam("exponent1", "boiler.heating.0.exponent");
                initRangeParam("gradient1", "boiler.heating.0.gradient");
                initRangeParam("offset1", "boiler.heating.0.offset");
                initRangeParam("roomtempcomp1", "boiler.heating.0.roomtempcomp");

                if ('roomtemp' in config.boiler.heating[0])
                    _("#selectRoomTempSource1").value = config.boiler.heating[0].roomtemp.source;

                _("#selectRoomTempSource1").dispatchEvent(new Event('change'));

                if ('roomsetpoint' in config.boiler.heating[0])
                    _("#selectRoomSetpointSource1").value = config.boiler.heating[0].roomsetpoint.source;
                _("#selectRoomSetpointSource1").dispatchEvent(new Event('change'));

                _("#chOn2").checked = config.boiler.heating[1].chOn;
                _("#overrideFlow2").checked = config.boiler.heating[1].overrideFlow || false;
                initRangeParam("chset2", "boiler.heating.1.flow");
                initRangeParam("roomset2", "boiler.heating.1.roomSet");
                initRangeParam("flowmax2", "boiler.heating.1.flowMax");
                initRangeParam("exponent2", "boiler.heating.1.exponent");
                initRangeParam("gradient2", "boiler.heating.1.gradient");
                initRangeParam("offset2", "boiler.heating.1.offset");
                initRangeParam("roomtempcomp2", "boiler.heating.1.roomtempcomp");

                if ('roomtemp' in config.boiler.heating[1])
                    _("#selectRoomTempSource2").value = config.boiler.heating[1].roomtemp.source;
                _("#selectRoomTempSource2").dispatchEvent(new Event('change'));

                if ('roomsetpoint' in config.boiler.heating[1])
                    _("#selectRoomSetpointSource2").value = config.boiler.heating[1].roomsetpoint.source;
                _("#selectRoomSetpointSource2").dispatchEvent(new Event('change'));

                drawMarkerTable();
                drawCurve();
            }

            var xhrStatus = new XMLHttpRequest();
            xhrStatus.timeout = 3000;
            xhrStatus.onload = (ev) => {
                try {
                    statuscache = JSON.parse(ev.target.responseText);
                }
                catch (err) {
                }

                _("#nocon").style.display = "none";

                let rtstr = "";
                let runtime = statuscache.runtime;
                rtstr = (runtime % 60) + " s";
                runtime = Math.floor(runtime / 60);
                if (runtime > 0) {
                    rtstr = (runtime % 60) + " m, " + rtstr;
                    runtime = Math.floor(runtime / 60);
                    if (runtime > 0) {
                        rtstr = (runtime % 24) + " h, " + rtstr;
                        runtime = Math.floor(runtime / 24);
                        if (runtime > 0) {
                            rtstr = runtime + " d, " + rtstr;
                        }
                    }
                }
                _("#runtime").innerText = rtstr;

                __(".statusvalue").forEach((ele) => {
                    var val = null;
                    if (!ele.hasAttribute('field'))
                        return;
                    try {
                        var f = ele.getAttribute('field').split('.');
                        val = statuscache;
                        for (var i=0; i<f.length; i++) {
                            val = val[f[i]];
                        }
                        
                        if ((val !== null) && (val !== undefined)) {
                            ele.innerText = val;
                            if (ele.hasAttribute('unit'))
                                ele.innerText += ' ' + ele.getAttribute('unit');
                        }
                    }
                    catch (ex) {
                        val = null;
                    }

                    if ((val !== null) && (val !== undefined))
                        ele.parentElement.style.display = "block";
                    else
                        ele.parentElement.style.display = "none";
                });

                __(".mqttbasetopic").forEach((ele) => {
                    ele.innerHTML = statuscache.mqtt.basetopic;
                });

                if ("1wire" in statuscache) {
                    __(".oneWireAdr").forEach((ele) => {
                        if (ele.childElementCount == 0) {
                            for (adr in statuscache["1wire"])
                                ele.append(_$("option", {textContent: adr}));

                            if ( (ele == _("#oneWireRoomTempAdr1")) && (config.boiler.heating[0].roomtemp.source == 3) )
                                ele.value = config.boiler.heating[0].roomtemp.adr;

                            if ( (ele == _("#oneWireRoomTempAdr2")) && (config.boiler.heating[1].roomtemp.source == 3) )
                                ele.value = config.boiler.heating[1].roomtemp.adr;
                        }
                    });

                    var i = 1;
                    for (adr in statuscache["1wire"]) {
                        if (_("#oneWireSensors").childElementCount < Object.keys(statuscache["1wire"]).length) {
                            _("#oneWireSensors").append(
                                _$("div", {className: "statusfield"},
                                    _$("h5", {textContent: adr}),
                                    _$("span", {className: "statusvalue"})
                                )
                            );
                        }
                        _("#oneWireSensors div:nth-child(" + i + ") span").innerText = statuscache["1wire"][adr] + " °C";
                        i++;
                    }
                }
                
                drawCurve();
                setTimeout(fetchStatus, 5000);
            };
            xhrStatus.ontimeout = (ev) => {
                _("#nocon").style.display = "block";
                setTimeout(fetchStatus, 10000);
            };

            function fetchStatus() {
                xhrStatus.open("GET", "status");
                xhrStatus.send();
            }
            fetchStatus();
            drawCurve(1);

            _("#reboot").onclick = (ev) => {
                let xhr = new XMLHttpRequest();
                xhr.open("GET", "/reboot");
                xhr.send("");
            };

            var xhrUpl = new XMLHttpRequest();
            _("#form_upload").onsubmit = (ev) =>{
                ev.preventDefault();

                var file = _("#inp_file").files[0];
                var formdata = new FormData();
                formdata.append(_("#inp_file").name, file, file.name);
                
                xhrUpl.upload.onprogress = (ev) => {
                    var perc = Math.round(ev.loaded / ev.total * 100);
                    _("#updprogress").value = perc;
                    _("#updprogress").innerText = perc + ' %';
                    _("#progressText").innerHTML = "Uploading...";
                };

                xhrUpl.onload = () => {
                    _("#inp_file").value = "";
                    _("#progressText").innerHTML = "Upload successful. Rebooting...";
                    setTimeout(() => {
                        location.reload();
                    }), "5000";
                };

                xhrUpl.onloadstart = () => {
                    _("#progressDiv").style.display = "block";
                    _("#btn_upload").disabled = true;
                    _("#inp_file").disabled = true;
                };

                xhrUpl.onerror = () => {
                    _("#progressText").innerHTML = "Error: " + ajaxUpl.status;
                };

                xhrUpl.open('post', '/update');
                xhrUpl.setRequestHeader('Access-Control-Allow-Headers', '*');
                xhrUpl.setRequestHeader('Access-Control-Allow-Origin', '*');
                xhrUpl.send(formdata);
            };

            let otModeItems = __('input[name="otMode"]');
            otModeItems.forEach(function (item) {
                item.onclick = (ev) => {
                    __('.otmode-repeater, .otmode-master, .otmode-test').forEach(function(ele) {
                        ele.style.display = "none";
                    });
                    switch (parseInt(item.value)) {
                        case 1:
                            // show elements for master mode
                            __('.otmode-master').forEach(function(ele) {
                                 ele.style.display = "block";
                            });
                            break;
                        case 2:
                            // show elements for repeater mode
                            __('.otmode-repeater').forEach(function(ele) {
                                 ele.style.display = "block";
                            });
                            break;
                        default:
                            break;
                    }                    
                }
            });

            function connectWS() {
                function logws(msg) {
                    let e = _$("div");
                    e.innerHTML = msg;
                    let cons = _("#console");
                    cons.append(e);
                    if (!_("#btnautoscroll").classList.contains("pressed"))
                        cons.scrollTop = cons.scrollHeight;
                }

                var websocket = new WebSocket("ws");
                websocket.onopen = (ev) => {
                    _("#logstatus").classList.add('connected');
                    _("#logstatus").classList.remove('disconnected');
                }
                websocket.onclose = (ev) => {
                    _("#logstatus").classList.add('disconnected');
                    _("#logstatus").classList.remove('connected');
                    setTimeout(function() {
                        connectWS();
                    }, 1000);
                }
                websocket.onmessage = (ev) => {
                    logws(ev.data);
                }
                websocket.onerror = (ev) => {
                    logws("Error");
                    websocket.close();
                }
            }
            connectWS();

            _("#btnclearlog").onclick = (ev) => {
                _("#console").innerHTML = "";
            };

            _("#btnautoscroll").onclick = (ev) => {
                ev.target.classList.toggle("pressed");
            }
        };

        function getMinOutsideTemp(rs, mf, g) {
            return rs - (mf - rs) / g; //minimal outside temperature at mf
        }

        /*
            ot: outside temperature
            rs: room set temperature
            mf: max. flow temperature
            n: heating exponent
            g: gradient
            s: shift
        */
        function getFlowTemperature(ot, rs, mf, n, g, s) {
            let am = getMinOutsideTemp(rs, mf, g);
            //calculate c1
            let c1 = (mf - rs) / ((rs - am) ** (1.0 / n));
            return rs + c1 * (rs - ot) ** (1.0 / n) + s;
        }

        function drawCurve(hk) {
            if (hk === undefined) {
                drawCurve(1);
                drawCurve(2);
                return;
            }
            var canvas = document.getElementById("canvas" + hk);
            var ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let origin = {
                x: 20,
                y: canvas.height - 20
            };
            let xaxis = {
                min: 20,
                max: -20,
                step: 5,
                zoom: (canvas.width - origin.x * 2) / (20 - (-20))
            };
            let yaxis = {
                min: 20,
                max: 90,
                step: 10,
                zoom: (canvas.height - (canvas.height - origin.y) * 2) / (90 - 20)
            }; //°C

            ctx.lineWidth = 1;
            ctx.strokeStyle = "#666";
            ctx.fillStyle = "#FFF";
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            ctx.font = '11px sans-serif';

            //draw horizontal grid
            ctx.beginPath();
            for (var i = yaxis.min; i <= yaxis.max; i += yaxis.step) {
                let y = origin.y - (i - yaxis.min) * yaxis.zoom;
                ctx.moveTo(origin.x, y);
                ctx.lineTo(origin.x + (xaxis.min - xaxis.max) * xaxis.zoom, y);
                ctx.fillText(i, origin.x - 10, y);
            }
            ctx.stroke();
            ctx.strokeStyle = "#333";
            ctx.beginPath();
            for (var i = yaxis.min + yaxis.step / 2; i <= yaxis.max; i += yaxis.step) {
                let y = origin.y - (i - yaxis.min) * yaxis.zoom;
                ctx.moveTo(origin.x, y);
                ctx.lineTo(origin.x + (xaxis.min - xaxis.max) * xaxis.zoom, y);
            }
            ctx.stroke();

            ctx.strokeStyle = "#666";
            //draw vertical grid
            ctx.beginPath();
            for (var i = xaxis.min; i >= xaxis.max; i -= xaxis.step) {
                let x = origin.x + (xaxis.min - i) * xaxis.zoom;
                ctx.moveTo(x, origin.y);
                ctx.lineTo(x, origin.y - (yaxis.max - yaxis.min) * yaxis.zoom);
                ctx.fillText(i, x, origin.y + 10);
            }
            ctx.stroke();
            ctx.strokeStyle = "#333";
            ctx.beginPath();
            for (var i = xaxis.min - xaxis.step / 2; i >= xaxis.max; i -= xaxis.step) {
                let x = origin.x + (xaxis.min - i) * xaxis.zoom;
                ctx.moveTo(x, origin.y);
                ctx.lineTo(x, origin.y - (yaxis.max - yaxis.min) * yaxis.zoom);
                ctx.stroke();
            }
            ctx.stroke();

            ctx.lineWidth = 2;
            ctx.strokeStyle = "#fff";

            //draw x-axis
            ctx.beginPath();
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(origin.x + (xaxis.min - xaxis.max) * xaxis.zoom, origin.y);
            ctx.stroke();

            //draw y-axis
            ctx.beginPath();
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(origin.x, origin.y - (yaxis.max - yaxis.min) * yaxis.zoom);
            ctx.stroke();
            ctx.save();
            ctx.rotate(-Math.PI / 2);
            ctx.fillText("flow / °C", -80, 30);
            ctx.restore();

            let roomset = parseFloat(_("#roomset" + hk + " input").value);
            let roomdelta = 0;
            if ("heatercircuit" in statuscache) {
                hc = statuscache.heatercircuit[hk - 1];
                if ("roomsetpoint" in hc) {
                    roomset = hc.roomsetpoint;
                    if ("roomtemp" in hc)
                        roomdelta = config.boiler.heating[hk-1].roomtempcomp * (roomset - hc.roomtemp);
                }
            }
                
            let flowmax = parseFloat(_("#flowmax" + hk + " input").value);
            let gradient = parseFloat(_("#gradient" + hk + " input").value);
            let exponent = parseFloat(_("#exponent" + hk + " input").value);
            let offset = parseFloat(_("#offset" + hk + " input").value);

            function getPoint(ot, ft) {
                return {
                    x: origin.x + (xaxis.min - ot) * xaxis.zoom,
                    y: origin.y - (ft - yaxis.min) * yaxis.zoom
                }
            }

            function drawMarkerPoint(p, color) {
                ctx.fillStyle = color;
                ctx.fillRect(p.x - 3, p.y - 3, 6, 6);    
            }

            let otStart = Math.min(roomset, xaxis.min);
            let ft = getFlowTemperature(otStart, roomset, flowmax, exponent, gradient, offset);
            let p1 = getPoint(otStart, ft); //foot

            drawMarkerPoint(p1, '#A33');

            function drawFlowCurve(color, delta) {
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                let ft = getFlowTemperature(otStart, roomset, flowmax, exponent, gradient, offset) + delta;
                let p = getPoint(otStart, ft);
                ctx.beginPath();
                ctx.moveTo(p.x, p.y);
                let otf = false;
                for (var ot = otStart; ot >= xaxis.max; ot -= 0.5) {
                    ft = getFlowTemperature(ot, roomset, flowmax, exponent, gradient, offset) + delta;

                    if ((ft >= flowmax) && !otf) {
                        ctx.stroke();
                        ctx.strokeStyle = "#888";
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y);
                        otf = true;
                    }

                    p = getPoint(ot, ft);
                    ctx.lineTo(p.x, p.y);

                    if (ft >= yaxis.max)
                        break;
                }
                ctx.stroke();
            }
            drawFlowCurve("#F00", 0);
            if (roomdelta != 0)
                drawFlowCurve("#0F0", roomdelta);

            //draw curve's basepoint
            drawMarkerPoint(p1, '#F00');

            if (statuscache.outsideTemp !== undefined) {
                //draw outsidetemp & it's flowtemperature
                let ftsensor = getFlowTemperature(statuscache.outsideTemp, roomset, flowmax, exponent, gradient, offset) + roomdelta;
                if (ftsensor > flowmax)
                    ftsensor = flowmax;
                let psensor = getPoint(statuscache.outsideTemp, ftsensor);
                drawMarkerPoint(psensor, '#F83');
                ctx.strokeStyle = "#F83";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(origin.x, psensor.y);
                ctx.lineTo(psensor.x, psensor.y);
                ctx.lineTo(psensor.x, origin.y);
                ctx.stroke();
                ctx.fillText(Math.round(ftsensor * 10) / 10, origin.x + 20, psensor.y - 8);
            }

            //draw markers
            config.boiler.heating[hk - 1].marker.forEach(function (m) {
                drawMarkerPoint(getPoint(m.ot, m.ft), '#3f8');
            });
        }
    </script>
</body>
</html>